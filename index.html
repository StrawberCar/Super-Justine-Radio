<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Super Justine Radio</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Modern, clean font (falls back to system if blocked) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800;900&display=swap" rel="stylesheet">
  <style>
    :root{
      /* Flat, no gradients */
      --bg:#0b0b0d;
      --surface:#121216;
      --surface-2:#1a1a20;
      --text:#f4f4f6;
      --text-dim:#b9bcc6;
      --line:#2a2a33;
      --line-2:#22222a;
      --chip:#17171c;
      --radius:14px;
      --radius-sm:12px;

      /* Per-playlist accents (changed via JS) */
      --accent:#b3123b;  /* default (Other) */
      --accent-2:#b3123b;
    }

    * { box-sizing: border-box }
    html, body {
      height: 100%;
      margin: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Inter, ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Header + flat playlist rail */
    .header {
      position: sticky; top: 0; z-index: 30;
      background: var(--bg);
      border-bottom: 1px solid var(--line);
    }
    .brand {
      padding: 12px 18px 8px;
      display: flex; align-items: center; gap: 10px;
    }
    .logo { width: 22px; height: 22px; border-radius: 6px; background: var(--accent); }
    .brand h1 { font-size: 16px; margin: 0; letter-spacing: 0.4px; text-transform: uppercase; color: var(--text-dim); }

    .playlist-rail {
      display: flex; gap: 8px; padding: 8px 12px 12px; overflow-x: auto; scrollbar-width: thin;
      border-top: 1px solid var(--line-2);
      user-select: none;
    }
    .pitem {
      display: grid; grid-template-columns: auto 1fr; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid var(--line-2);
      background: var(--surface);
      cursor: pointer; min-width: 200px;
      transition: transform .06s ease, border .12s ease, background .12s ease;
      position: relative;
    }
    .pitem:hover { transform: translateY(-1px); border-color: var(--line); }
    .pitem.active { border-color: var(--accent); }
    .picon {
      width: 32px; height: 32px; border-radius: 8px; background:#181820; display:grid; place-items:center;
      border:1px solid var(--line-2); overflow:hidden; font-size:18px;
      color: var(--text);
    }
    .picon img { width:100%; height:100%; object-fit:cover; }
    .plabel { font-weight: 800; letter-spacing:.2px; }

    /* Shell */
    .shell{
      max-width: 1200px; margin: 16px auto; padding: 0 16px 20px;
      display: grid; grid-template-rows: auto auto; gap: 14px;
    }

    /* NOW PLAYING (flat) */
    .player {
      background: var(--surface);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      display: grid;
      grid-template-columns: 360px 1fr;
      grid-template-rows: auto 1fr auto;
      min-height: 58vh;
      overflow: clip;
    }
    .art {
      grid-row: 1 / span 3; grid-column: 1;
      border-right: 1px solid var(--line-2);
      background: #0f0f14;
      display: grid; place-items: center;
    }
    .art img {
      width: 86%; aspect-ratio: 1/1; object-fit: cover;
      border-radius: var(--radius-sm); background: #14141a; border: 1px solid var(--line-2);
    }

    .meta {
      grid-column: 2; grid-row: 1;
      padding: 16px 16px 4px 16px; display: grid; gap: 10px;
    }
    .title { font-size: 44px; line-height: 1.08; font-weight: 900; letter-spacing: 0.1px }
    .subrow { display:flex; flex-wrap:wrap; gap:16px; color: var(--text-dim); font-size: 16px; }
    .meta-item { display:inline-flex; align-items:center; gap:10px; }
    .meta-item svg { width:22px; height:22px; fill: var(--text-dim); }

    .tags { display:flex; gap:8px; flex-wrap:wrap }
    .tag { font-size: 12px; color: var(--text-dim); padding: 4px 10px; border-radius: 999px; border: 1px solid var(--line-2); background: #141419; }

    .controls {
      grid-column: 2; grid-row: 2; padding: 8px 16px; display: grid; gap: 12px;
    }
    .transport { display:flex; align-items:center; gap: 10px; }
    .btn {
      height: 42px; min-width: 42px;
      border: 1px solid var(--line);
      background: #18181e;
      border-radius: 11px; display: inline-grid; place-items: center;
      cursor: pointer; user-select: none; transition: transform .04s ease, border .12s ease, background .12s ease;
    }
    .btn:active { transform: translateY(1px) }
    .btn[aria-pressed="true"] { border-color: var(--accent) }
    .btn svg { width: 18px; height:18px; fill: var(--text) }
    .spacer { flex: 1 1 auto }

    /* SCRUBBER ‚Äì FLAT + VISIBLE */
    .time { display:grid; grid-template-columns: 64px 1fr 64px; align-items:center; gap: 12px; font-variant-numeric: tabular-nums; }
    .bar {
      position: relative; height: 12px; background: #15151b; border-radius: 8px; overflow: hidden;
      border: 1px solid var(--line);
    }
    .bar .buffered { position:absolute; top:0; left:0; height:100%; width:0%; background:#20202a; }
    .bar .progress { position:absolute; top:0; left:0; height:100%; width:0%; background: var(--accent); }
    .scrub {
      position:absolute; inset:-6px 0; appearance:none; background: transparent; cursor: pointer; height: calc(100% + 12px);
      z-index: 3; outline: none;
    }
    /* Make sure the slider is visible across browsers */
    .scrub::-webkit-slider-runnable-track { height: 24px; background: transparent; }
    .scrub::-moz-range-track { height: 24px; background: transparent; }
    .scrub::-webkit-slider-thumb { -webkit-appearance: none; width:16px; height:16px; border-radius:50%; background: var(--text); border: 2px solid var(--accent); }
    .scrub::-moz-range-thumb { width:16px; height:16px; border-radius:50%; background: var(--text); border: 2px solid var(--accent); }

    .volume { display:flex; align-items:center; gap:8px; }
    .volume input[type="range"]{ width:160px; height:6px; accent-color: var(--accent); background: transparent; }

    .footer {
      grid-column: 1 / -1; grid-row: 3;
      padding: 10px 12px; display:flex; align-items:center; gap:10px;
      border-top: 1px solid var(--line-2); color: var(--text-dim); font-size: 12px;
      background: var(--surface);
    }
    .footer .dl { margin-left: auto; display:flex; gap:8px; align-items:center; }
    .link-btn{ padding:8px 12px; border-radius:10px; text-decoration:none; color:var(--text); border:1px solid var(--line); background:#18181e; }

    /* TRACK GRID (flat, responsive, 5-wide on large) */
    .tracks { background: var(--surface); border: 1px solid var(--line); border-radius: var(--radius); padding: 10px 12px 14px; }
    .tracks h2 { margin: 2px 6px 10px; font-size: 13px; color: var(--text-dim); font-weight: 800; letter-spacing:.2px; text-transform: uppercase; }

    .grid { display:grid; gap:10px; grid-template-columns: repeat(2, minmax(0, 1fr)); }
    @media (min-width: 620px){ .grid { grid-template-columns: repeat(3, minmax(0,1fr)); } }
    @media (min-width: 880px){ .grid { grid-template-columns: repeat(4, minmax(0,1fr)); } }
    @media (min-width: 1180px){ .grid { grid-template-columns: repeat(5, minmax(0,1fr)); } } /* 5 per row */

    .track-card {
      border-radius: 12px; overflow: hidden; border: 1px solid var(--line);
      background: #191920; cursor: pointer; transition: transform .04s ease, border .12s ease, background .12s ease;
      display:grid; grid-template-rows: auto auto;
    }
    .track-card:hover { transform: translateY(-2px); border-color: var(--line); }
    .track-card.active { outline: 2px solid var(--accent); border-color: var(--accent); }

    .track-media { width:100%; aspect-ratio: 1/1; background:#101016; display:grid; place-items:center; border-bottom: 1px solid var(--line-2); }
    .track-media img { width:100%; height:100%; object-fit: cover }
    .track-media .emoji { font-size: 56px; opacity: 0.95 }

    .track-body { padding:10px 10px 12px }
    .track-title { font-size: 15px; font-weight: 800; line-height: 1.25 }
    .track-sub { font-size: 12px; color: var(--text-dim); margin-top: 6px }

    @media (max-width: 900px) {
      .player { grid-template-columns: 1fr; grid-template-rows: auto auto auto }
      .art { grid-column: 1 / -1; grid-row: 1 / 2; padding: 16px }
      .art img { width: 260px }
      .meta { grid-column: 1 / -1; }
      .controls { grid-column: 1 / -1; }
      .title { font-size: 34px; }
      .subrow { font-size: 15px; }
    }
  </style>
</head>
<body>

  <!-- ============================================================
       SUPER JUSTINE RADIO ‚Äî Dev-controlled config below
       Themes per playlist (flat colors). Filenames preserved.
       ============================================================ -->
  <script>
    const LIBRARY = {
      playlists: [
        /* ------------------ SJW1 (Royal Theatre vibe: deep purple + gold) ------------------ */
        {
          id: "SJW1",
          title: "Super Justine World 1",
          icon: "üë©‚Äçü¶∞",
          color: { accent: "#7a2bc4", accent2: "#caa33a" }, // purple + gold
          description: "What do you think lmao",
          tracks: [
            {
              id: "menu1",
              title: "Super Justine World 1 Menu",
              displayTitle: "Super Justine World 1 Menu",
              artist: "Strawber",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/Menu.png",
              files: [{ src: "music/SJW1/menu.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/menu.mp3",
              tags: ["Relaxing","Justine","Calming"]
            },
            {
              id: "overworld",
              title: "Super Justine World Overworld Theme",
              artist: "Strawber",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/JUSTINEOVERWORLDTHEME.png",
              files: [{ src: "music/SJW1/JUSTINEOVERWORLDTHEME.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/JUSTINEOVERWORLDTHEME.mp3",
              tags: ["DEATHITSELFDEATHITSELFDEATHITSELFDEATHITSELFDEATHITSELFDEATHITSELFDEATHITSELFDEATHSELF","Justine ofc"]
            },
            {
              id: "icey",
              title: "Super Justine World Icey Theme",
              artist: "Strawber",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/icey theme.png",
              files: [{ src: "music/SJW1/icey theme.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/icey theme.mp3",
              tags: ["man it is COLD today","Justine ofc"]
            },
            {
              id: "JIMC",
              title: "Justine in my car!",
              artist: "Strawber",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/justine in my car.png",
              files: [{ src: "music/SJW1/justine in my car.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/justine in my car.mp3",
              tags: ["DRIVING","IN","MY","CAR","RIGHT","AFTER","COMMERCE","HEY","THAT","HEAD","IS","AS SHINY","AS MY BEER"]
            },
            {
              id: "boss1",
              title: "Balatro GOTY Theme",
              artist: "LocalThunk",
              album: "Balatro",
              year: 2025,
              artwork: "art/SJW1/boss.png",
              files: [{ src: "music/SJW1/boss.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/boss.m4a",
              tags: ["GAMBLING!!!!!!!","OH THE DAY THAT I FOUND BALATRO, I JUST KNEW MY HEART WAS FINALLY FULL."]
            },
            {
              id: "morning",
              title: "Justine's Morning Routine",
              artist: "Strawber and some other old dude who made the OG",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/justine'sMorningRoutine.png",
              files: [{ src: "music/SJW1/justine'sMorningRoutine.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/justine'sMorningRoutine.mp3",
              tags: ["No, this isnt the grow a garden song","hi im here"]
            },
            {
              id: "tvtime",
              title: "It's Justine Time!",
              artist: "Strawber (Forked from Toby Fox's TV Time)",
              album: "Super Justine World 1",
              year: 2025,
              artwork: "art/SJW1/itsjustinetime.png",
              files: [{ src: "music/SJW1/itsjustinetime.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW1/itsjustinetime.mp3",
              tags: ["ITS.. T. V. TIMMEEEEEEE","hi im ALSO here"]
            }
          ]
        },

        /* ------------------ SJW2 (Arcade neon: cyan + magenta) ------------------ */
        {
          id: "SJW2",
          title: "Super Justine World 2",
          icon: "art/SJW2/Chapter1 Start.png",
          color: { accent: "#06d7ff", accent2: "#ff1fff" }, // arcade neon
          description: "idk its the second one",
          tracks: [
            {
              id: "10secondtimer",
              title: "Prepare to quiz!",
              artist: "Strawber, Kahoot",
              album: "Super Justine World 2",
              year: 2025,
              artwork: "art/SJW2/10secondtimer.png",
              files: [{ src: "music/SJW2/10secondtimer.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW2/10secondtimer.mp3",
              tags: ["timer","beeps"]
            },
            {
              id: "BossFight",
              title: "The return of marshall. (Hard Refresh)",
              artist: "Strawber, Algorave Dave",
              album: "Super Justine World 2",
              year: 2025,
              artwork: null,
              files: [{ src: "music/SJW2/BossFight.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW2/BossFight.mp3",
              tags: ["battle", "OF JUSTINE"]
            },
            {
              id: "Chapter1StartOLD",
              title: "Chapter 1 Start (OLD)",
              artist: "Strawber",
              album: "Super Justine World 2",
              year: 2025,
              artwork: "art/SJW2/Chapter1 Start (OLD).png",
              files: [{ src: "music/SJW2/Chapter1 Start (OLD).mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW2/Chapter1 Start (OLD).mp3",
              tags: ["prototype", "of justine"]
            },
            {
              id: "Chapter1Start",
              title: "Chapter 1 Start",
              artist: "Strawber",
              album: "Super Justine World 2",
              year: 2025,
              artwork: "art/SJW2/Chapter1 Start.png",
              files: [{ src: "music/SJW2/Chapter1 Start.wav", type: "audio/wav" }],
              downloadUrl: "music/SJW2/Chapter1 Start.wav",
              tags: ["intro", "to hell"]
            },
            {
              id: "GUNSHOTPARADE",
              title: "Gunshot Parade",
              artist: "Strawber",
              album: "Super Justine World 2",
              year: 2025,
              artwork: "art/SJW2/GUNSHOTPARADE.png",
              files: [{ src: "music/SJW2/GUNSHOTPARADE.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW2/GUNSHOTPARADE.mp3",
              tags: ["loud", "quiet"]
            },
            {
              id: "sadjustine",
              title: "The Sad and Twisted turn of the story.",
              artist: "Strawber",
              album: "Super Justine World 2",
              year: 2025,
              artwork: "art/SJW2/sadjustine.png",
              files: [{ src: "music/SJW2/sadjustine.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW2/sadjustine.mp3",
              tags: ["sad", "NOOO JUSTINEEEE"]
            }
          ]
        },

        /* ------------------ SJW3 (Toddler drawn vibe: playful green + orange) ------------------ */
        {
          id: "SJW3",
          title: "Super Justine World 3",
          icon: "art/SJW3/menu.png",
          color: { accent: "#42c778", accent2: "#ffb84d" }, // playful
          description: "The third one",
          tracks: [
            {
              id: "Menu",
              title: "Super Justine World 3 Menu Theme",
              artist: "Strawber",
              album: "Super Justine World 3",
              year: 2025,
              artwork: "art/SJW3/menu.png",
              files: [{ src: "music/SJW3/Menu.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW3/Menu.mp3",
              tags: ["menu", "I should stop"]
            },
            {
              id: "BossReprise",
              title: "A complete and utter destruction of the in game world we have come to know so well.",
              artist: "Strawber",
              album: "Super Justine World 3",
              year: 2025,
              artwork: "art/SJW3/FinalBoss.png",
              files: [{ src: "music/SJW3/BossReprise.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/SJW3/BossReprise.mp3",
              tags: ["boss", "MOSS", "loss", ":Ã∂.Ã∂|Ã∂:Ã∂;Ã∂"]
            }
          ]
        },

        /* ------------------ Other (Default maroon) ------------------ */
        {
          id: "Other",
          title: "Other",
          icon: "art/Other/DeathByChiptuneAlbum.png",
          color: { accent: "#b3123b", accent2: "#b3123b" },
          description: "Misc tracks",
          tracks: [
            {
              id: "DeathByChiptune",
              title: "Death By Chiptune",
              artist: "Strawber",
              album: "Other",
              year: 2025,
              artwork: "art/Other/DeathByChiptuneAlbum.png",
              files: [{ src: "music/Other/Death By Chiptune.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/Other/Death By Chiptune.mp3",
              tags: ["chiptune", "justinetune", "loonytune"]
            },
            {
              id: "justinethebutlerengine",
              title: "Justine The Butler Engine",
              artist: "Strawber",
              album: "Other",
              year: 2025,
              artwork: "art/Other/JustineTheButlerEngineAlbum.png",
              files: [{ src: "music/Other/justine the butler engine.mp3", type: "audio/mpeg" }],
              downloadUrl: "music/Other/justine the butler engine.mp3",
              tags: ["misc", "WHY JUST WHY"]
            }
          ]
        }
      ]
    };
  </script>

  <header class="header">
    <div class="brand">
      <div class="logo" aria-hidden="true"></div>
      <h1>SUPER JUSTINE RADIO</h1>
    </div>
    <nav class="playlist-rail" id="playlistBar" aria-label="Choose playlist"></nav>
  </header>

  <main class="shell">
    <!-- NOW PLAYING -->
    <section class="player" aria-label="Now Playing">
      <aside class="art"><img id="artImg" alt="Artwork"></aside>

      <div class="meta">
        <div class="title" id="trackTitle">‚Äî</div>
        <div class="subrow" id="metaRow">
          <span class="meta-item" id="metaArtist">
            <svg viewBox="0 0 24 24"><path d="M12 12a4 4 0 1 0-4-4 4 4 0 0 0 4 4Zm0 2c-4.42 0-8 2.24-8 5v1h16v-1c0-2.76-3.58-5-8-5Z"/></svg>
            <span>‚Äî</span>
          </span>
          <span class="meta-item" id="metaAlbum">
            <svg viewBox="0 0 24 24"><path d="M6 2h12a2 2 0 0 1 2 2v16l-8-4-8 4V4a2 2 0 0 1 2-2Z"/></svg>
            <span>‚Äî</span>
          </span>
          <span class="meta-item" id="metaYear">
            <svg viewBox="0 0 24 24"><path d="M7 2h10a2 2 0 0 1 2 2v16l-7-3-7 3V4a2 2 0 0 1 2-2z"/></svg>
            <span>‚Äî</span>
          </span>
        </div>
        <div class="tags" id="tagRow"></div>
      </div>

      <div class="controls">
        <div class="transport">
          <button class="btn" id="prevBtn" title="Previous (K)">
            <svg viewBox="0 0 24 24"><path d="M6 6h2v12H6zM20 6v12L9 12z"/></svg>
          </button>
          <button class="btn" id="playBtn" title="Play/Pause (Space)" aria-pressed="false">
            <svg id="playIcon" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
            <svg id="pauseIcon" viewBox="0 0 24 24" style="display:none"><path d="M6 5h4v14H6zM14 5h4v14h-4z"/></svg>
          </button>
          <button class="btn" id="nextBtn" title="Next (J)">
            <svg viewBox="0 0 24 24"><path d="M16 6h2v12h-2zM4 6l11 6-11 6z"/></svg>
          </button>

          <div class="spacer"></div>

          <div class="time">
            <div id="curTime">0:00</div>
            <div class="bar" id="seekBar">
              <div class="buffered" id="bufferedBar"></div>
              <div class="progress" id="progressBar"></div>
              <input class="scrub" id="scrub" type="range" min="0" max="1000" value="0" step="1" aria-label="Seek">
            </div>
            <div id="durTime">0:00</div>
          </div>

          <div class="volume" title="Volume (‚Üë/‚Üì)">
            <svg viewBox="0 0 24 24" width="18" height="18" aria-hidden="true"><path fill="currentColor" d="M5 9v6h4l5 5V4L9 9H5z"/></svg>
            <input type="range" id="vol" min="0" max="1" step="0.01" value="1" aria-label="Volume">
          </div>

          <div class="actions">
            <button class="btn" id="loopBtn" title="Loop (L)" aria-pressed="false">
              <svg viewBox="0 0 24 24"><path d="M7 7h7V4l5 4-5 4V9H7v6h4v2H7a2 2 0 0 1-2-2V9a2 2 0 0 1 2-2zm10 4h-4v2h4v3h-7v3l-5-4 5-4v3h7v-3z"/></svg>
            </button>
            <button class="btn" id="shuffleBtn" title="Shuffle (S)" aria-pressed="false">
              <svg viewBox="0 0 24 24"><path d="M14.82 12.94 11.88 10l2.94-2.94L18 10.24V7h2v7h-7v-2h3.24zM10.59 9 9 7.41 4.41 12 9 16.59 10.59 15 8.17 12.59zM14 17h-1.59l-2-2H14v-2h-5.59l-2-2H10V9H6.41l-2-2H2v2h1.59l10 10H14z"/></svg>
            </button>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Meow i was here i guess idk</div>
        <div class="dl">
          <a id="downloadBtn" class="link-btn" href="#" download>Download</a>
          <a id="openFileBtn" class="link-btn" href="#" target="_blank" rel="noopener">Open File</a>
        </div>
      </div>

      <audio id="audio" preload="metadata" crossorigin="anonymous"></audio>
    </section>

    <!-- TRACK GRID -->
    <section class="tracks" aria-label="Track List">
      <h2>Tracks in Playlist</h2>
      <div class="grid" id="trackGrid"></div>
    </section>
  </main>

  <script>
    // ---------- State ----------
    let currentPlaylistIndex = 0;
    let currentTrackIndex = 0;
    let isShuffle = false;
    let isLoop = false;

    // ---------- Elements ----------
    const playlistBar = document.getElementById('playlistBar');
    const grid = document.getElementById('trackGrid');
    const artImg = document.getElementById('artImg');
    const titleEl = document.getElementById('trackTitle');
    const tagRow = document.getElementById('tagRow');
    const metaArtist = document.querySelector('#metaArtist span');
    const metaAlbum = document.querySelector('#metaAlbum span');
    const metaYear = document.querySelector('#metaYear span');

    const audio = document.getElementById('audio');
    const playBtn = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const pauseIcon = document.getElementById('pauseIcon');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const loopBtn = document.getElementById('loopBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');

    const curTime = document.getElementById('curTime');
    const durTime = document.getElementById('durTime');
    const progressBar = document.getElementById('progressBar');
    const bufferedBar = document.getElementById('bufferedBar');
    const scrub = document.getElementById('scrub');

    const vol = document.getElementById('vol');
    const downloadBtn = document.getElementById('downloadBtn');
    const openFileBtn = document.getElementById('openFileBtn');

    // ---------- Helpers ----------
    const pad = n => String(Math.floor(n)).padStart(2, '0');
    const fmt = secs => {
      if (!isFinite(secs)) return "0:00";
      const m = Math.floor(secs / 60);
      const s = Math.floor(secs % 60);
      return `${m}:${pad(s)}`;
    };

    function saveState() {
      const st = { p: currentPlaylistIndex, t: currentTrackIndex, time: audio.currentTime, vol: audio.volume, shuffle: isShuffle, loop: isLoop };
      localStorage.setItem('SJR_STATE', JSON.stringify(st));
    }
    function loadState() {
      try {
        const st = JSON.parse(localStorage.getItem('SJR_STATE') || '{}');
        if (typeof st.p === 'number') currentPlaylistIndex = Math.max(0, Math.min(LIBRARY.playlists.length-1, st.p));
        if (typeof st.t === 'number') currentTrackIndex = Math.max(0, st.t);
        if (typeof st.vol === 'number') audio.volume = st.vol;
        if (typeof st.shuffle === 'boolean') isShuffle = st.shuffle;
        if (typeof st.loop === 'boolean') isLoop = st.loop;
      } catch {}
    }

    const getCurrentPlaylist = () => LIBRARY.playlists[currentPlaylistIndex];
    const getCurrentTrack = () => getCurrentPlaylist()?.tracks?.[currentTrackIndex] || null;

    function setThemeForPlaylist(pl){
      const a = pl?.color?.accent || '#b3123b';
      const b = pl?.color?.accent2 || a;
      document.documentElement.style.setProperty('--accent', a);
      document.documentElement.style.setProperty('--accent-2', b);
      // also tint the small logo
      document.querySelector('.logo').style.background = a;
    }

    function setPlayButton(isPlaying) {
      playBtn.setAttribute('aria-pressed', String(isPlaying));
      playIcon.style.display = isPlaying ? 'none' : '';
      pauseIcon.style.display = isPlaying ? '' : 'none';
    }

    function updateTimeUI() {
      curTime.textContent = fmt(audio.currentTime || 0);
      const d = audio.duration || 0;
      durTime.textContent = fmt(d);
      const p = d ? (audio.currentTime / d) : 0;
      progressBar.style.width = `${(p * 100).toFixed(2)}%`;

      try {
        if (audio.buffered && audio.buffered.length) {
          const end = audio.buffered.end(audio.buffered.length - 1);
          const pb = d ? (end / d) : 0;
          bufferedBar.style.width = `${(pb * 100).toFixed(2)}%`;
        }
      } catch {}
    }

    function bindSources(track) {
      audio.innerHTML = "";
      const files = track.files || [];
      for (const f of files) {
        const s = document.createElement('source');
        s.src = f.src;
        if (f.type) s.type = f.type;
        audio.appendChild(s);
      }
      const firstSrc = files[0]?.src || "#";
      openFileBtn.href = firstSrc;
      downloadBtn.href = track.downloadUrl || firstSrc;
      downloadBtn.setAttribute('download', track.displayTitle || track.title || 'download');
    }

    function renderTags(tags = []) {
      tagRow.innerHTML = "";
      tags.slice(0, 6).forEach(t => {
        const el = document.createElement('div');
        el.className = 'tag';
        el.textContent = t;
        tagRow.appendChild(el);
      });
    }

    function renderTrackGrid(pl) {
      grid.innerHTML = "";
      pl.tracks.forEach((tr, idx) => {
        const card = document.createElement('div');
        card.className = 'track-card';
        card.dataset.index = String(idx);

        const media = document.createElement('div');
        media.className = 'track-media';
        if (tr.artwork) {
          const img = document.createElement('img'); img.src = tr.artwork; img.alt = tr.displayTitle || tr.title || "Artwork";
          media.appendChild(img);
        } else if (pl.icon && /\.(png|jpg|jpeg|webp|svg)$/i.test(pl.icon)) {
          const img = document.createElement('img'); img.src = pl.icon; img.alt = pl.title;
          media.appendChild(img);
        } else {
          const em = document.createElement('div'); em.className = 'emoji'; em.textContent = '‚ô™'; media.appendChild(em);
        }

        const body = document.createElement('div');
        body.className = 'track-body';
        const t = document.createElement('div'); t.className = 'track-title'; t.textContent = tr.displayTitle || tr.title || "Untitled";
        const sub = document.createElement('div'); sub.className = 'track-sub'; sub.textContent = [tr.artist, tr.album].filter(Boolean).join(" ‚Ä¢ ");

        body.appendChild(t); body.appendChild(sub);
        card.appendChild(media); card.appendChild(body);
        grid.appendChild(card);
      });
      highlightActiveCard();
    }

    function highlightActiveCard() {
      Array.from(grid.children).forEach((c,i)=> c.classList.toggle('active', i===currentTrackIndex));
    }

    function setArtwork(pl, tr){
      if (tr.artwork) { artImg.src = tr.artwork; return; }
      if (pl.icon && /\.(png|jpg|jpeg|webp|svg)$/i.test(pl.icon)) { artImg.src = pl.icon; return; }
      // Flat fallback plate
      const color = encodeURIComponent(getComputedStyle(document.documentElement).getPropertyValue('--accent').trim() || '#b3123b');
      artImg.src = `data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='700' height='700'><rect width='100%' height='100%' fill='${color}'/></svg>`;
    }

    function loadTrack(idx, {autoplay=false} = {}) {
      const pl = getCurrentPlaylist(); if (!pl) return;
      currentTrackIndex = Math.max(0, Math.min(pl.tracks.length-1, idx));
      const tr = getCurrentTrack(); if (!tr) return;

      titleEl.textContent = tr.displayTitle || tr.title || "Untitled";
      metaArtist.textContent = tr.artist || "‚Äî";
      metaAlbum.textContent = tr.album || "‚Äî";
      metaYear.textContent = tr.year || "‚Äî";
      setArtwork(pl, tr);
      renderTags(tr.tags);

      bindSources(tr);
      audio.load();

      highlightActiveCard();
      saveState();

      if (autoplay) audio.play().catch(()=>{});
    }

    function loadPlaylist(index, {keepTrack=false} = {}) {
      currentPlaylistIndex = Math.max(0, Math.min(LIBRARY.playlists.length-1, index));
      const pl = getCurrentPlaylist();
      setThemeForPlaylist(pl);
      renderTrackGrid(pl);
      if (!keepTrack) currentTrackIndex = 0;
      loadTrack(currentTrackIndex, {autoplay:false});
      saveState();
      highlightActivePlaylist();
    }

    function renderPlaylistRail() {
      playlistBar.innerHTML = "";
      LIBRARY.playlists.forEach((pl, i) => {
        const item = document.createElement('div');
        item.className = 'pitem';
        item.setAttribute('role','button');
        item.setAttribute('tabindex','0');
        item.setAttribute('aria-pressed', i===currentPlaylistIndex ? 'true':'false');

        const icon = document.createElement('div'); icon.className = 'picon';
        if (pl.icon && /\.(png|jpg|jpeg|webp|svg)$/i.test(pl.icon)) {
          const img = document.createElement('img'); img.src = pl.icon; img.alt = pl.title; icon.appendChild(img);
        } else {
          icon.textContent = (pl.icon && typeof pl.icon === 'string') ? pl.icon : '‚ô™';
        }
        icon.style.borderColor = (pl.color?.accent || '#b3123b');
        const lbl = document.createElement('div'); lbl.className = 'plabel'; lbl.textContent = pl.title;
        lbl.style.color = (i===currentPlaylistIndex) ? (pl.color?.accent || '#b3123b') : '';

        item.appendChild(icon); item.appendChild(lbl);
        item.addEventListener('click', () => loadPlaylist(i));
        item.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' ') { e.preventDefault(); loadPlaylist(i); }});
        playlistBar.appendChild(item);
      });
      highlightActivePlaylist();
    }

    function highlightActivePlaylist() {
      Array.from(playlistBar.children).forEach((c,i)=>{
        const pl = LIBRARY.playlists[i];
        c.classList.toggle('active', i===currentPlaylistIndex);
        c.style.borderColor = (i===currentPlaylistIndex) ? (pl.color?.accent || '#b3123b') : getComputedStyle(document.documentElement).getPropertyValue('--line-2');
        c.setAttribute('aria-pressed', i===currentPlaylistIndex ? 'true':'false');
        const lbl = c.querySelector('.plabel');
        lbl.style.color = (i===currentPlaylistIndex) ? (pl.color?.accent || '#b3123b') : '';
      });
    }

    // ---------- Controls ----------
    playBtn.addEventListener('click', () => { if (audio.paused) audio.play(); else audio.pause(); });
    prevBtn.addEventListener('click', () => {
      const pl = getCurrentPlaylist(); if (!pl) return;
      currentTrackIndex = (currentTrackIndex - 1 + pl.tracks.length) % pl.tracks.length;
      loadTrack(currentTrackIndex, {autoplay:true});
    });
    nextBtn.addEventListener('click', () => nextTrack());

    loopBtn.addEventListener('click', () => { isLoop = !isLoop; loopBtn.setAttribute('aria-pressed', String(isLoop)); saveState(); });
    shuffleBtn.addEventListener('click', () => { isShuffle = !isShuffle; shuffleBtn.setAttribute('aria-pressed', String(isShuffle)); saveState(); });

    vol.addEventListener('input', () => { audio.volume = Number(vol.value); saveState(); });

    // Scrubber (drag + click anywhere)
    let scrubbing = false;
    function seekToRatio(r){
      r = Math.max(0, Math.min(1, r));
      const d = audio.duration || 0;
      audio.currentTime = d * r;
      const pos = r * 1000;
      scrub.value = String(Math.round(pos));
      updateTimeUI();
    }
    scrub.addEventListener('input', () => {
      scrubbing = true;
      const pos = Number(scrub.value)/1000;
      const d = audio.duration || 0;
      progressBar.style.width = `${(pos*100).toFixed(2)}%`;
      curTime.textContent = fmt(d * pos);
    });
    scrub.addEventListener('change', () => { seekToRatio(Number(scrub.value)/1000); scrubbing = false; });
    // clicks on the bar jump too
    document.getElementById('seekBar').addEventListener('mousedown', (e)=>{
      const rect = e.currentTarget.getBoundingClientRect();
      const ratio = (e.clientX - rect.left) / rect.width;
      seekToRatio(ratio);
    });

    // Track grid click
    grid.addEventListener('click', (e) => {
      const card = e.target.closest('.track-card');
      if (!card) return;
      const idx = Number(card.dataset.index);
      loadTrack(idx, {autoplay:true});
    });

    // Audio events
    audio.addEventListener('play', () => { setPlayButton(true); });
    audio.addEventListener('pause', () => { setPlayButton(false); saveState(); });
    audio.addEventListener('timeupdate', () => {
      if (!scrubbing) {
        updateTimeUI();
        const d = audio.duration || 1;
        const pos = (audio.currentTime / d) * 1000;
        scrub.value = String(Math.max(0, Math.min(1000, pos)));
      }
    });
    audio.addEventListener('progress', updateTimeUI);
    audio.addEventListener('loadedmetadata', updateTimeUI);
    audio.addEventListener('ended', () => {
      if (isLoop) { audio.currentTime = 0; audio.play(); return; }
      nextTrack();
    });

    function nextTrack(){
      const pl = getCurrentPlaylist(); if (!pl) return;
      if (isShuffle && pl.tracks.length > 1) {
        let n = currentTrackIndex;
        while (n === currentTrackIndex) n = Math.floor(Math.random() * pl.tracks.length);
        currentTrackIndex = n;
      } else {
        currentTrackIndex = (currentTrackIndex + 1) % pl.tracks.length;
      }
      loadTrack(currentTrackIndex, {autoplay:true});
    }

    // Keyboard shortcuts
    window.addEventListener('keydown', (e)=>{
      if (['INPUT','TEXTAREA','SELECT'].includes(e.target.tagName)) return;
      switch(e.key.toLowerCase()){
        case ' ': e.preventDefault(); if (audio.paused) audio.play(); else audio.pause(); break;
        case 'j': nextBtn.click(); break;
        case 'k': prevBtn.click(); break;
        case 'l': loopBtn.click(); break;
        case 's': shuffleBtn.click(); break;
        case 'arrowleft': audio.currentTime = Math.max(0, audio.currentTime - 5); break;
        case 'arrowright': audio.currentTime = Math.min(audio.duration || Infinity, audio.currentTime + 5); break;
        case 'arrowup': audio.volume = Math.min(1, (audio.volume || 0) + 0.05); vol.value = String(audio.volume); break;
        case 'arrowdown': audio.volume = Math.max(0, (audio.volume || 0) - 0.05); vol.value = String(audio.volume); break;
      }
    });

    // ---------- Init ----------
    (function init(){
      loadState();
      renderPlaylistRail();
      loadPlaylist(currentPlaylistIndex, {keepTrack:true});

      const saved = JSON.parse(localStorage.getItem('SJR_STATE') || '{}');
      if (saved?.time && isFinite(saved.time)) {
        audio.addEventListener('loadedmetadata', function restoreOnce(){
          audio.currentTime = Math.min(audio.duration || saved.time, saved.time);
          audio.removeEventListener('loadedmetadata', restoreOnce);
        });
      }
      vol.value = String(audio.volume);
      shuffleBtn.setAttribute('aria-pressed', String(isShuffle));
      loopBtn.setAttribute('aria-pressed', String(isLoop));
    })();
  </script>
</body>
</html>
